<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hanya: <?=I18n::_("system.editor.title")?></title>
		{head()}
		<link rel="stylesheet" href="assets/system/stylesheets/hanya.admin.css" type="text/css" media="screen">
		<link rel="stylesheet" href="assets/system/stylesheets/codemirror.css" type="text/css" media="screen">
		<link rel="stylesheet" href="assets/system/stylesheets/codemirror.theme.css" type="text/css" media="screen">
		<script src="assets/system/javascripts/codemirror.js" type="text/javascript" charset="utf-8"></script>
		<script src="assets/system/javascripts/codemirror.css.js" type="text/javascript" charset="utf-8"></script>
		<script src="assets/system/javascripts/codemirror.xml.js" type="text/javascript" charset="utf-8"></script>
		<script src="assets/system/javascripts/codemirror.js.js" type="text/javascript" charset="utf-8"></script>
		<script src="assets/system/javascripts/codemirror.htmlmixed.js" type="text/javascript" charset="utf-8"></script>
		<script src="assets/system/javascripts/codemirror.overlay.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css" media="screen">
				
			.navigator {
				background-color: white;
				padding: 15px 20px;
				border: 1px solid #ddd;
			}

			.navigator ul ul li {
				padding-left: 20px;
			}

			.navigator li a, .navigator li span {
				display: block;
				padding: 3px 0;
				padding-left: 20px;
				vertical-align: middle;
				margin: 5px 0;
				color: inherit;
				text-decoration: none;
				font-weight: inherit;
			}
			
			.navigator li.directory span, .navigator li.directory a {
				background: url(assets/system/images/directory-closed.png) 0 center no-repeat;
			}
			
			.navigator li.file span, #navigator li.file a {
				background: url(assets/system/images/file.png) 0 center no-repeat;
			}
			
			.navigator li.file span:hover {
				cursor: pointer;
			}
			
			.navigator li#open span {
				font-weight: bold;
			}
			
			#editor {
				background-color: white;
				border: 1px solid #ddd;
			}
			
			.CodeMirror-scroll {
				height: auto; overflow: scroll;
			}
			
			#modified {
				color: red;
			}
			
			.cm-hanyaTag {
				color: violet;
			}
			
			.cm-hanyaVar {
				color: red;
			}
			
			.cm-hanyaDef {
				color: blue;
			}
			
			.cm-hanyaMeta {
				color: red;
				font-weight: bold;
			}
			
		</style>
		<script type="text/javascript" charset="utf-8">
		
			// Highlight Definitions
			CodeMirror.defineMode("hanyaMeta", function(config, parserConfig) {
			  var hanyaMetaOverlay = {
			    token: function(stream, state) {
			      if (stream.match("//--") || stream.match("--//")) {
			        return "hanyaMeta";
			      }
			      while (stream.next() != null && !stream.match("/", false)) {}
			      return null;
			    }
			  };
			  return CodeMirror.overlayParser(CodeMirror.getMode(config, parserConfig.backdrop || "text/html"), hanyaMetaOverlay);
			});
		
			// Highlight Definitions
			CodeMirror.defineMode("hanyaDef", function(config, parserConfig) {
			  var hanyaDefOverlay = {
			    token: function(stream, state) {
			      if (stream.match("[def") || stream.match("[/def")) {
			        while ((ch = stream.next()) != null)
			          if (ch == "]" && stream.next() == "}") break;
			        return "hanyaDef";
			      }
			      while (stream.next() != null && !stream.match("[", false)) {}
			      return null;
			    }
			  };
			  return CodeMirror.overlayParser(CodeMirror.getMode(config, parserConfig.backdrop || "hanyaMeta"), hanyaDefOverlay);
			});
		
			// Higlight Tags
			CodeMirror.defineMode("hanyaTag", function(config, parserConfig) {
			  var hanyaTagOverlay = {
			    token: function(stream, state) {
			      if (stream.match("{tag")) {
			        while ((ch = stream.next()) != null)
			          if (ch == ")" && stream.next() == "}") break;
			        return "hanyaTag";
			      }
			      while (stream.next() != null && !stream.match("{", false)) {}
			      return null;
			    }
			  };
			  return CodeMirror.overlayParser(CodeMirror.getMode(config, parserConfig.backdrop || "hanyaDef"), hanyaTagOverlay);
			});
			
			// Higlight Vars
			CodeMirror.defineMode("hanyaVar", function(config, parserConfig) {
			  var hanyaVarOverlay = {
			    token: function(stream, state) {
			      if (stream.match("$")) {
			        while ((ch = stream.next()) != null)
			          if (ch == ")") break;
			        return "hanyaVar";
			      }
			      while (stream.next() != null && !stream.match("$", false)) {}
			      return null;
			    }
			  };
			  return CodeMirror.overlayParser(CodeMirror.getMode(config, parserConfig.backdrop || "hanyaTag"), hanyaVarOverlay);
			});
			
			// Variables
			var editor;
			
			// On Startup
			$(document).ready(function(){
				
				// Navigator Interactivity
				$(".navigator li.file span").click(function(){
					window.location = "?command=editor&file="+$(this).data("path");
				});				
				
				// Load Source & Start Editor
				$("#editor textarea").load("?command=editor_source&file=<?=$current_file?>",{},function(){
					editor = CodeMirror.fromTextArea(document.getElementById("codemirror"),{
						mode: "hanyaVar",
						tabMode: "shift",
						lineNumbers: true,
						onChange: function() {
							$("#modified").show();
						},
					});
				});
				
				// Hide Modified
				$("#modified").hide();
				
			});
			
			// Save file
			function save() {
				$.ajax({
					url: "?command=editor_save&file=<?=$current_file?>",
					type: "POST",
					data: { source: editor.getValue() },
					success: function(data) {
						if(data=="ok") {
							$("#modified").hide();
						}
					}
				})
			}
			
		</script>
  </head>
  <body id="hanya-admin">
		<div class="hanya-toolbar" >
			<div class="hanya-toolbar-left" >
				<?=HTML::anchor(".",I18n::_("system.admin.back_to_site"))?>
				<a href="javascript:save()"><?=I18n::_("system.editor.save")?></a>
			</div>
		</div>
		<h1><?=I18n::_("system.editor.title")?> (<?=$current_file?>) <span id="modified"><?=I18n::_("system.editor.modified")?></span></h1>
		<div class="wrapper">
			<div class="w1">
				<h2><?=I18n::_("system.editor.tree")?></h2>
				<div class="navigator">
					<?=Editor_Plugin::tree($current_file,"tree")?>
				</div>
				<hr/>
				<h2><?=I18n::_("system.editor.elements")?></h2>
				<div class="navigator">
					<?=Editor_Plugin::tree($current_file,"elements")?>
				</div>
			</div>
			<div class="w3-last">
				<div id="editor">
					<textarea name="sourcecode" id="codemirror"></textarea>
				</div>
			</div>
		</div>
  </body>
</html>